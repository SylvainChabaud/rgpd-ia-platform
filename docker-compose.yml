# Docker Compose - Production Configuration
# LOT 6.0 - Stack IA Docker RGPD-ready
#
# SECURITY REQUIREMENTS:
# - NO secrets in this file (use .env or Docker secrets)
# - NO ports exposed except reverse-proxy (80/443)
# - Internal networks isolated (internal: true)
# - All services run as non-root users
#
# USAGE:
#   1. Copy .env.example to .env and configure secrets
#   2. Run: docker-compose up -d
#   3. Verify: ./scripts/docker/security-check.sh

version: '3.9'

services:
  # Reverse Proxy - ONLY public entry point
  reverse-proxy:
    image: nginx:1.27-alpine
    container_name: rgpd-platform-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - nginx_ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - rgpd_frontend
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PostgreSQL Database - INTERNAL ONLY
  db:
    image: postgres:16-alpine
    container_name: rgpd-platform-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: ${DB_NAME:-rgpd_platform}
      # Security hardening
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - rgpd_data
    # NO PORTS EXPOSED - internal access only
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Security: limit resources
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Ollama Local LLM - INTERNAL ONLY
  ollama:
    image: ollama/ollama:latest
    container_name: rgpd-platform-ollama
    restart: unless-stopped
    networks:
      - rgpd_backend
    volumes:
      - ollama_data:/root/.ollama
    # NO PORTS EXPOSED - internal access only
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Security: limit resources
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G

  # Next.js Application - BACKEND + FRONTEND
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    container_name: rgpd-platform-app
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      # Database connection (uses secret)
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME:-rgpd_platform}
      # Security secrets (mounted from files)
      SESSION_SECRET_FILE: /run/secrets/session_secret
      JWT_SECRET_FILE: /run/secrets/jwt_secret
      BOOTSTRAP_PLATFORM_SECRET_FILE: /run/secrets/bootstrap_platform_secret
      EMAIL_ENCRYPTION_KEY_FILE: /run/secrets/email_encryption_key
      # AI Configuration
      AI_PROVIDER: ${AI_PROVIDER:-stub}
      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: ${OLLAMA_MODEL:-tinyllama}
      OLLAMA_TIMEOUT: ${OLLAMA_TIMEOUT:-30000}
      # Observability (LOT 6.1)
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # Feature flags
      BOOTSTRAP_MODE: ${BOOTSTRAP_MODE:-false}
    secrets:
      - session_secret
      - jwt_secret
      - bootstrap_platform_secret
      - email_encryption_key
    networks:
      - rgpd_frontend
      - rgpd_backend
      - rgpd_data
    # NO PORTS EXPOSED - access via reverse-proxy only
    depends_on:
      db:
        condition: service_healthy
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Security: limit resources
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

# Network isolation (EPIC 2 + EPIC 6)
networks:
  # Frontend network - bridge mode (reverse-proxy needs internet)
  rgpd_frontend:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # Backend network - INTERNAL ONLY (app <-> ollama)
  rgpd_backend:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/24

  # Data network - INTERNAL ONLY (app <-> db)
  rgpd_data:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.22.0.0/24

# Persistent volumes (encrypted at rest - OS level)
volumes:
  postgres_data:
    driver: local
  ollama_data:
    driver: local
  nginx_ssl:
    driver: local
  nginx_logs:
    driver: local

# Docker Secrets (external files - NOT in git)
# Generate with: ./scripts/docker/init-secrets.sh
secrets:
  db_password:
    file: ./secrets/db_password.txt
  session_secret:
    file: ./secrets/session_secret.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  bootstrap_platform_secret:
    file: ./secrets/bootstrap_platform_secret.txt
  email_encryption_key:
    file: ./secrets/email_encryption_key.txt
